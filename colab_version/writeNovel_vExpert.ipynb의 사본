{"cells":[{"cell_type":"code","execution_count":null,"metadata":{"id":"-nMsa6IWreM4"},"outputs":[],"source":["!pip install -q --upgrade google-generativeai"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"H-FfsiWTlyKa"},"outputs":[],"source":["from google.colab import userdata\n","import getpass\n","import os\n","import google.generativeai as genai\n","\n","# 실행하기 전에 열쇠창에 API키를 등록하세요.\n","GOOGLE_API_KEY=userdata.get('GOOGLE_API_KEY')\n","\n","genai.configure(api_key=GOOGLE_API_KEY)\n","\n","if \"GOOGLE_API_KEY\" not in os.environ:\n","    os.environ[\"GOOGLE_API_KEY\"] = GOOGLE_API_KEY\n","\n","model = genai.GenerativeModel('gemini-pro')"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"buwAiBj0GYh7"},"outputs":[],"source":["import time\n","import re\n","from tqdm.notebook import tqdm\n","from google.generativeai import types as genai\n","\n","# 소설 제목을 입력하세요.\n","prompt_title = \"파친코\"\n","\n","# 작성 규칙을 입력하세요.\n","prompt_rule = \"\"\"{아래의 모든 조건들은 반드시 준수해야 합니다:\n","조건0 : 소설 전개를 아주 천천히 진행하시오.\n","조건1 : 영어 사용금지.\n","조건2 : 중국어 사용금지.\n","조건3 : 숫자 사용금지.\n","조건4 : 스토리가 이어질 수 있는 문장으로 마무리 하시오.\n","조건5 : 마지막에 구두점(.)으로 문장을 마무리 하시오.\n","조건6 : 'HARM_CATEGORY'에 속하는 문장을 절대로 생성하지 마시오.\n","조건7 : 스토리의 결말을 지어서는 안됨.\n","조건8 : 줄바꿈을 자주 활용하시오.\n","조건9 : 대명사 사용을 자제하고, 주인공의 이름을 지속적으로 사용하시오.\n","조건10 : 인물들간에 대화를 자주 삽입 하시오.\n","조건11 : 한국어 이외의 언어 사용금지}\"\"\"\n","\n","# 등장인물을 입력하세요.\n","prompt_char = \"\"\"{등장인물은 다음과 같습니다:\n","최민호, 33세, 기업가, 냉정하고 비즈니스 중심적인 성격\n","한지연, 28세, 예술가, 낙천적이고 자유로운 영혼\n","박성재, 36세, 변호사, 미소가 많은 친절한 성격\n","신지훈, 40세, 정치인, 적극적이고 야망 넘치는 성격}\n","\"\"\"\n","# 시간-공간적 배경을 입력하세요.\n","prompt_back = \"\"\"{시간-공간적 배경은 다음과 같습니다:\n","2040년, 현대 도시의 초고층 아파트에서 이 이야기는 전개됩니다.\n","이 도시는 현대화된 모습과 미래적인 기술로 가득 차 있으며, 사람들은 다양한 관점으로 미래에 대한 꿈을 키우고 있습니다.\n","하지만 이 아파트에 사는 사람들은 각자의 속마음과 비밀을 품고 살아가고 있습니다.}\n","\"\"\"\n","\n","# # 사건의 시작점을 입력하세요. == 안쓰는게 나을듯. 다른 context로 수정해서 쓰세요.\n","# prompt_event = \"\"\"{소설의 시작은 다음과 같습니다:\n","# 한 가운데 숲 속에 위치한 고요한 마을에서, 오랜 만에 일어난 이상한 사건이 마을 사람들을 놀라게 하고 있다.\n","# 어느 날, 마을 근처의 숲에서 이상한 빛과 함께 등장한 이상한 신비한 생명체들이 마을 주민들과 대면하려 한다.\n","# 이 신비로운 생명체들은 자신들의 목적을 밝히려 하며, 마을 사람들은 그들의 등장으로 인해 새로운 현실에 직면하게 된다.\n","# 마을 사람들은 신비로운 생명체들이 가져온 변화에 대한 두려움과 호기심을 가지며, 마을의 운명이 뒤바뀌게 될 것인지에 대한 긴장과 기대가 고조된다.}\n","# \"\"\"\n","\n","# 시작을 위한 지시사항을 입력하세요.\n","prompt_start = \"\"\"{당신은 한국의 저명한 소설가입니다. 당신에게 소설을 작성해달라는 거액의 부탁이 들어와서 소설 작성 작업을 시작합니다.\n","고객의 요구사항은 다음과 같습니다: {prompt_title}, {prompt_rule}, {prompt_char}, {prompt_back}\n","당신의 모든 에너지와 집중력을 발휘해서 최고의 소설을 작성해주세요.\n","\"\"\"\n","\n","# 마무리를 위한 지시사항을 입력하세요.\n","prompt_end = \"조건 : 진행되고 있던 소설을 매끄럽게 마무리 합니다. 확실하게 마무리 하세요. 마무리 이후에는 더 이상의 아무런 문장도 생성하지 않습니다.\"\n","\n","prompt_basic = prompt_title + prompt_rule + prompt_char + prompt_back + prompt_start\n","\n","prompt = \"\"\n","myNovel = \"\""]},{"cell_type":"code","source":["# 종종 실행이 안됩니다. 그럴경우 런타임 연결해제 및 재시작 후 다시 시도하세요.\n","# 노이즈 방지를 위해서 n(작업횟수)의 값을 예상보다 높게 설정하세요.\n","\n","n = 50\n","\n","def generate_selected_sentences(text):\n","    sentences = text.split('.')\n","    selected_sentences = \"\"\n","    for index in [-50, -40, -35, -30, -25, -20, -16, -12, -8, -4, 1]:\n","        try:\n","            selected_sentences = '.'.join(sentences[index::-1]).strip()\n","            break\n","        except IndexError:\n","            continue\n","    if not selected_sentences:\n","        selected_sentences = '.'.join(sentences[1:])\n","    return selected_sentences\n","\n","for i in tqdm(range(n), desc=\"Generating Text\"):\n","    current_prompt = prompt_end if i == n - 1 else prompt_basic + prompt\n","    try:\n","        generation_config = genai.GenerationConfig(temperature=1.0)\n","        response = model.generate_content(current_prompt, generation_config=generation_config)\n","        if not response.candidates:\n","            print(f\"프롬프트 {i}에 대한 유효한 후보가 생성되지 않았습니다. response.prompt_feedback를 확인하세요.\")\n","            print(f\"프롬프트 피드백: {response.prompt_feedback}\")\n","            continue\n","        generated_text = response.text\n","        if not generated_text:\n","            print(f\"응답에 텍스트가 포함되지 않았습니다. 다음 반복으로 건너뜁니다.\")\n","            continue\n","        if re.search(\"[^가-힣\\s\\n!\\\"'\\.,?~]\", generated_text):\n","            print(f\"생성된 텍스트에 노이즈가 있습니다. 다음 반복으로 건너뜁니다.\")\n","            continue\n","        selected_sentences = generate_selected_sentences(prompt)\n","        prompt = selected_sentences + '\\n'\n","        myNovel += generated_text\n","    except ValueError as e:\n","        if i == n - 1:\n","            print(f\"마지막 반복에서 오류가 발생했습니다. 다시 시도합니다.\")\n","            continue\n","        else:\n","            print(f\"반복 {i}에서 오류가 발생했습니다. 다음 반복으로 건너뜁니다.\")\n","            continue\n","\n","print(myNovel)"],"metadata":{"colab":{"base_uri":"https://localhost:8080/","height":86,"referenced_widgets":["93998fe2b6a745cea3e106ae10356f3b","4bd743a9afd0444a8bbf0981303dfa38","ccfeec7033d5473d96d838ec97dfaf55","6bbb81b50d44483da35d32e02c8ab6d8","10497fe91c054fa48908991caf08e10d","140d2fd4cff940628a18666358526f20","826f36ab7b3b4cceb8802d9f1452ef84","c230f9b1682c4ebfa4445fea5c287554","e224f9d7156a42f1b6d2bf25a8208475","5703fb32072d47d9940f6829f3538ff5","d0e05b00e4054396b6e5d558d9abac8b"]},"id":"_1lSlevlWlS8","outputId":"637f45bb-e25a-459c-c3a6-6956e64da471"},"execution_count":null,"outputs":[{"output_type":"display_data","data":{"text/plain":["Generating Text:   0%|          | 0/50 [00:00<?, ?it/s]"],"application/vnd.jupyter.widget-view+json":{"version_major":2,"version_minor":0,"model_id":"93998fe2b6a745cea3e106ae10356f3b"}},"metadata":{}},{"output_type":"stream","name":"stdout","text":["생성된 텍스트에 노이즈가 있습니다. 다음 반복으로 건너뜁니다.\n","생성된 텍스트에 노이즈가 있습니다. 다음 반복으로 건너뜁니다.\n"]}]},{"cell_type":"code","source":["from datetime import datetime\n","import os\n","\n","# 저장 경로를 설정하세요.\n","save_directory = \"/content/myNovel/\"\n","\n","# 디렉토리가 없으면 생성\n","if not os.path.exists(save_directory):\n","    os.makedirs(save_directory)\n","\n","current_time = datetime.now().strftime(\"%Y%m%d_%H%M%S\")\n","novel_file_name = f\"{save_directory}{current_time}_myNovel.txt\"\n","prompt_file_name = f\"{save_directory}{current_time}_prompt.txt\"\n","\n","with open(novel_file_name, \"w\", encoding=\"utf-8\") as novel_file:\n","    novel_file.write(myNovel)\n","print(f\"텍스트 저장완료: {novel_file_name}\")\n","\n","with open(prompt_file_name, \"w\", encoding=\"utf-8\") as prompt_file:\n","    prompt_file.write(prompt_basic)\n","print(f\"프롬프트 저장완료: {prompt_file_name}\")"],"metadata":{"id":"bdiYk3R5Iy7-"},"execution_count":null,"outputs":[]}],"metadata":{"colab":{"provenance":[{"file_id":"1tcEgbus1tFzQWi9B3WKXYdfSWx5CO8P3","timestamp":1704040282999},{"file_id":"1-gwpiWIXumFGtYt-hW5lC6hr1wJ8M_KW","timestamp":1703859129438}],"mount_file_id":"1KWBFTf-Bnn_kQACBmIFruxd207bDnowa","authorship_tag":"ABX9TyOFqdQ2eNJncFvl7yMN9Mrp"},"kernelspec":{"display_name":"Python 3","name":"python3"},"language_info":{"name":"python"},"widgets":{"application/vnd.jupyter.widget-state+json":{"93998fe2b6a745cea3e106ae10356f3b":{"model_module":"@jupyter-widgets/controls","model_name":"HBoxModel","model_module_version":"1.5.0","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_model_name":"HBoxModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"1.5.0","_view_name":"HBoxView","box_style":"","children":["IPY_MODEL_4bd743a9afd0444a8bbf0981303dfa38","IPY_MODEL_ccfeec7033d5473d96d838ec97dfaf55","IPY_MODEL_6bbb81b50d44483da35d32e02c8ab6d8"],"layout":"IPY_MODEL_10497fe91c054fa48908991caf08e10d"}},"4bd743a9afd0444a8bbf0981303dfa38":{"model_module":"@jupyter-widgets/controls","model_name":"HTMLModel","model_module_version":"1.5.0","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"1.5.0","_view_name":"HTMLView","description":"","description_tooltip":null,"layout":"IPY_MODEL_140d2fd4cff940628a18666358526f20","placeholder":"​","style":"IPY_MODEL_826f36ab7b3b4cceb8802d9f1452ef84","value":"Generating Text:   4%"}},"ccfeec7033d5473d96d838ec97dfaf55":{"model_module":"@jupyter-widgets/controls","model_name":"FloatProgressModel","model_module_version":"1.5.0","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_model_name":"FloatProgressModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"1.5.0","_view_name":"ProgressView","bar_style":"","description":"","description_tooltip":null,"layout":"IPY_MODEL_c230f9b1682c4ebfa4445fea5c287554","max":50,"min":0,"orientation":"horizontal","style":"IPY_MODEL_e224f9d7156a42f1b6d2bf25a8208475","value":2}},"6bbb81b50d44483da35d32e02c8ab6d8":{"model_module":"@jupyter-widgets/controls","model_name":"HTMLModel","model_module_version":"1.5.0","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"1.5.0","_view_name":"HTMLView","description":"","description_tooltip":null,"layout":"IPY_MODEL_5703fb32072d47d9940f6829f3538ff5","placeholder":"​","style":"IPY_MODEL_d0e05b00e4054396b6e5d558d9abac8b","value":" 2/50 [00:22&lt;08:57, 11.19s/it]"}},"10497fe91c054fa48908991caf08e10d":{"model_module":"@jupyter-widgets/base","model_name":"LayoutModel","model_module_version":"1.2.0","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"1.2.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"1.2.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"overflow_x":null,"overflow_y":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"140d2fd4cff940628a18666358526f20":{"model_module":"@jupyter-widgets/base","model_name":"LayoutModel","model_module_version":"1.2.0","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"1.2.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"1.2.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"overflow_x":null,"overflow_y":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"826f36ab7b3b4cceb8802d9f1452ef84":{"model_module":"@jupyter-widgets/controls","model_name":"DescriptionStyleModel","model_module_version":"1.5.0","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_model_name":"DescriptionStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"1.2.0","_view_name":"StyleView","description_width":""}},"c230f9b1682c4ebfa4445fea5c287554":{"model_module":"@jupyter-widgets/base","model_name":"LayoutModel","model_module_version":"1.2.0","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"1.2.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"1.2.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"overflow_x":null,"overflow_y":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"e224f9d7156a42f1b6d2bf25a8208475":{"model_module":"@jupyter-widgets/controls","model_name":"ProgressStyleModel","model_module_version":"1.5.0","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_model_name":"ProgressStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"1.2.0","_view_name":"StyleView","bar_color":null,"description_width":""}},"5703fb32072d47d9940f6829f3538ff5":{"model_module":"@jupyter-widgets/base","model_name":"LayoutModel","model_module_version":"1.2.0","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"1.2.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"1.2.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"overflow_x":null,"overflow_y":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"d0e05b00e4054396b6e5d558d9abac8b":{"model_module":"@jupyter-widgets/controls","model_name":"DescriptionStyleModel","model_module_version":"1.5.0","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_model_name":"DescriptionStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"1.2.0","_view_name":"StyleView","description_width":""}}}}},"nbformat":4,"nbformat_minor":0}